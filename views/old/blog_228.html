<p>이번 강좌에서는</p><ul><li><p> <code class='inline-code'>move</code> 문법 (move semantics)</p></li><li><p> 완벽한 전달 (perfect forwarding)</p></li><li><p> 레퍼런스 겹침 (reference collapsing)</p></li></ul><p>등에 대해 다룹니다.</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile21.uf.tistory.com%2Fimage%2F999F4B3D5ABA1979118454' alt=''><p>안녕하세요 여러분! 지난번의 우측값 레퍼런스 강의는 어떠셨나요? 우측값 레퍼런스를 통해서, 기존에는 불가능하였던 우측값에 대한 복사가 아닌 이동의 구현이 가능하게 되었습니다.</p><p>하지만, 만약에 좌측값도 이동을 시키고 싶다면 어떨까요? 예를 들어서 아래와 같이 두 변수의 값을 바꾸는 <code class='inline-code'>swap</code> 함수를 생각해보세요.</p>
<pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">my_swap</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">tmp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>위 <code class='inline-code'>my_swap</code> 함수에서 <code class='inline-code'>tmp</code> 라는 임시 객체를 생성한 뒤에, b 를 <code class='inline-code'>a</code> 에 복사하고, <code class='inline-code'>b</code> 에 <code class='inline-code'>a</code> 를 복사하게 됩니다. 문제는 무려 복사를 쓸데없이 3 번이나 한다는 점입니다. 예를 들어서 <code class='inline-code'>T</code> 가 <code class='inline-code'>MyString</code> 인 경우를 생각해봅시다.</p><pre class="chroma">
<span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span><span class="err"> </span><span class="nc">MyString</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">string_content</span><span class="p">;</span>  <span class="c1">// 문자열 데이터를 가리키는 포인터
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">string_length</span><span class="p">;</span>     <span class="c1">// 문자열 길이
</span><span class="c1"></span>
  <span class="kt">int</span> <span class="n">memory_capacity</span><span class="p">;</span>  <span class="c1">// 현재 할당된 용량
</span><span class="c1"></span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">MyString</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 문자열로 부터 생성
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 복사 생성자
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 이동 생성자
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="n">MyString</span> <span class="o">&amp;</span><span class="o">&amp;</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">reserve</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
  <span class="o">~</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="kt">int</span> <span class="nf">length</span><span class="p">(</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">복사 생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="n">MyString</span> <span class="o">&amp;</span><span class="o">&amp;</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">이동 생성자 호출 !</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">memory_capacity</span><span class="p">;</span>

  <span class="c1">// 임시 객체 소멸 시에 메모리를 해제하지
</span><span class="c1"></span>  <span class="c1">// 못하게 한다.
</span><span class="c1"></span>  <span class="n">str</span><span class="p">.</span><span class="n">string_content</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="o">~</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">string_content</span><span class="p">)</span> <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">string_content</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">reserve</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">memory_capacity</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">prev_string_content</span> <span class="o">=</span> <span class="n">string_content</span><span class="p">;</span>

    <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">size</span><span class="p">]</span><span class="p">;</span>
    <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
      <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">prev_string_content</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">prev_string_content</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">MyString</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MyString</span> <span class="n">str</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">string_length</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">)</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">string_length</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">string_length</span> <span class="o">=</span> <span class="n">string_length</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span> <span class="o">&amp;</span><span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">복사!</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">string_length</span> <span class="o">&gt;</span> <span class="n">memory_capacity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">string_content</span><span class="p">;</span>
    <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>
    <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">string_length</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">println</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">my_swap</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">tmp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MyString</span> <span class="n">str1</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">abc</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="nf">str2</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">def</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Swap 전 -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">str1</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">str2</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Swap 후 -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">my_swap</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">)</span><span class="p">;</span>
  <span class="n">str1</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">str2</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>성공적으로 컴파일 하였다면</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile2.uf.tistory.com%2Fimage%2F99115F3E5AB8FD86061B59' alt=''><p>와 같이 나옵니다.</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">my_swap</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">tmp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>위 <code class='inline-code'>my_swap</code> 함수를 살펴봅시다. 일단, 첫번째 줄에서, <code class='inline-code'>a</code> 가 좌측값이기 때문에 <code class='inline-code'>tmp</code> 의 복사 생성자가 호출됩니다. 따라서 1 차적으로 <code class='inline-code'>a</code> 가 차지하는 공간 만큼 메모리 할당이 발생한 후 <code class='inline-code'>a</code> 의 데이터가 복사됩니다.</p><pre class="chroma">
<span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
</pre><p>두 번째로 <code class='inline-code'>a =</code> b; 에서 2 차적으로 복사가 발생합니다. 그리고 마지막으로,</p><pre class="chroma">
<span class="n">b</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
</pre><p>에서 또 한번 문자열 전체의 복사가 이루어지게 됩니다. 무려 <code class='inline-code'>swap</code> 을 하기 위해 문자열 전체 복사를 3번이나 해야 합니다. 아래 그림처럼 말입니다.</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile28.uf.tistory.com%2Fimage%2F9960ED4D5AB96B7D09D8A7' alt=''><p>하지만 우리는 굳이 문자열 내용을 복사할 필요 없이 각 <code class='inline-code'>MyString</code> 객체의 <code class='inline-code'>string_content</code> 주소값만 서로 바꿔주면 되는 것을 알고 있습니다. (물론 <code class='inline-code'>string_length</code> 와 <code class='inline-code'>memory_capacity</code> 도 바꿔야겠지만, 이들은 단순히 4바이트 <code class='inline-code'>int</code> 복사 이기 때문에 속도에 영향을 주지는 않습니다).</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile27.uf.tistory.com%2Fimage%2F997263435AB96BB9085570' alt=''><p>하지만 위를 <code class='inline-code'>my_swap</code> 에서 구현하기 위해서는 여러가지 문제가 있습니다. 일단 첫번째로 <code class='inline-code'>my_swap</code> 함수는 <code class='inline-code'>generic</code> 한 함수 입니다. 다시 말해,</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">my_swap</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span>
</pre><p>위 함수가 일반적인 타입 <code class='inline-code'>T</code> 에 대해 작동해야 한다는 의미이지요. 하지만 위 <code class='inline-code'>string_content</code> 의 경우 <code class='inline-code'>MyString</code> 에만 존재하는 필드이기 때문에 일반적인 타입 <code class='inline-code'>T</code> 에 대해서는 작동하지 않습니다. 물론 그렇다고 해서 불가능 한 것은 아닙니다. 아래 처럼 템플릿 특수화를 이용하면 되기 때문이죠.</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">my_swap</span><span class="p">(</span><span class="n">MyString</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...
</span><span class="c1"></span><span class="p">}</span>
</pre><p>문제는 <code class='inline-code'>string_content</code> 가 <code class='inline-code'>private</code> 이기 때문에, 이를 위해 <code class='inline-code'>MyString</code> 내부에 <code class='inline-code'>swap</code> 관련한 함수를 만들어야 된다는 것입니다. 사실 이렇게 된다면 굳이 <code class='inline-code'>my_swap</code> 이라는 함수를 정의할 필요가 없게 됩니다.</p><p>위 문제를 원래의 <code class='inline-code'>my_swap</code> 함수를 사용하면서 좀 더 깔끔하게 해결할 수 있는 방법은 없을까요?</p><pre class="chroma">
<span class="n">T</span> <span class="nf">tmp</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
</pre><p>먼저 기존의 <code class='inline-code'>my_swap</code> 함수를 다시 살펴봅시다. 우리는 위 문장이 복사 생성자 대신에, 이동 생성자가 되기를 원합니다. 왜냐하면 <code class='inline-code'>tmp</code> 를 복사생성 할 필요 없이, 단순히 <code class='inline-code'>a</code> 를 잠깐 옮겨놓기만 하면 되기 때문이지요. 하지만 문제는 <code class='inline-code'>a</code> 가 좌측값이라는 점입니다 ('a' 라는 실체가 있으므로). 따라서 지금 이 상태로는 우리가 무얼 해도 이동 생성자는 오버로딩 되지 않습니다.</p><p>그렇다면, 좌측값이 우측값으로 취급될 수 있게 바꿔주는 함수 같은 것이 있을까요? 즉, 어떠한 좌측값이 이동 될 수 있도록 말이죠.</p><h3><p>  move 문법 (move semantics)</p></h3><pre class="chroma">
<span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span><span class="err"> </span><span class="nc">MyString</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">string_content</span><span class="p">;</span>  <span class="c1">// 문자열 데이터를 가리키는 포인터
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">string_length</span><span class="p">;</span>     <span class="c1">// 문자열 길이
</span><span class="c1"></span>
  <span class="kt">int</span> <span class="n">memory_capacity</span><span class="p">;</span>  <span class="c1">// 현재 할당된 용량
</span><span class="c1"></span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">MyString</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 문자열로 부터 생성
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 복사 생성자
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 이동 생성자
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="n">MyString</span> <span class="o">&amp;</span><span class="o">&amp;</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">reserve</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
  <span class="o">~</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="kt">int</span> <span class="nf">length</span><span class="p">(</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">복사 생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="n">MyString</span> <span class="o">&amp;</span><span class="o">&amp;</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">이동 생성자 호출 !</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">memory_capacity</span><span class="p">;</span>

  <span class="c1">// 임시 객체 소멸 시에 메모리를 해제하지
</span><span class="c1"></span>  <span class="c1">// 못하게 한다.
</span><span class="c1"></span>  <span class="n">str</span><span class="p">.</span><span class="n">string_content</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">string_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">memory_capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="o">~</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">string_content</span><span class="p">)</span> <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">string_content</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">reserve</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">memory_capacity</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">prev_string_content</span> <span class="o">=</span> <span class="n">string_content</span><span class="p">;</span>

    <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">size</span><span class="p">]</span><span class="p">;</span>
    <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
      <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">prev_string_content</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">prev_string_content</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">MyString</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MyString</span> <span class="n">str</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">string_length</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">)</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">string_length</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">string_length</span> <span class="o">=</span> <span class="n">string_length</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">string_length</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">println</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MyString</span> <span class="n">str1</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">abc</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">이동 전 -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str1 : </span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">str1</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">이동 후 -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="nf">str2</span><span class="p">(</span><span class="n">move</span><span class="p">(</span><span class="n">str1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str1 : </span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">str1</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str2 : </span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">str2</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>성공적으로 컴파일 하였다면</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile7.uf.tistory.com%2Fimage%2F99BE55345AB99D231E151B' alt=''><p>와 같이 나옵니다.</p><pre class="chroma">
<span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">이동 후 -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="n">MyString</span> <span class="nf">str2</span><span class="p">(</span><span class="n">move</span><span class="p">(</span><span class="n">str1</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</pre><p>부분을 살펴보도록 합시다. 놀랍게도 <code class='inline-code'>str2</code> 의 복사 생성자가 아닌 이동 생성자가 호출되었습니다. C++ 11 에 새롭게 추가된 <code class='inline-code'>move</code> 함수는 입력받은 좌측값을 이동 가능한 값으로 캐스팅 해줍니다.사실 <code class='inline-code'>move</code> 함수가 수정하는 것은 아무 것도 없습니다. 다만 컴파일러가 <code class='inline-code'>move</code> 함수가 리턴하는 값을 '이동 가능 하구나' 라고 생각하게 해주지요.</p><pre class="chroma">
<span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str1 : </span><span class="s">&#34;</span><span class="p">;</span>
<span class="n">str1</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str2 : </span><span class="s">&#34;</span><span class="p">;</span>
<span class="n">str2</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
</pre><p>그렇게 이동 된 후에 문자열들을 출력해보면 <code class='inline-code'>str1</code> 에는 빈 문자열이, <code class='inline-code'>str2</code> 에는 원래의 <code class='inline-code'>str1</code> 의 문자열이 들어있음을 알 수 있습니다. 이 과정에서 문자열 전체 복사는 한 번도 발생하지 않고 단순히 <code class='inline-code'>string_content</code> 의 값만 복사되었을 뿐입니다.</p><p>자 이제 이 새로운 <code class='inline-code'>move</code> 를 이용해서 위 <code class='inline-code'>my_swap</code> 함수를 수정해보도록 합시다.</p><pre class="chroma">
<span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span><span class="err"> </span><span class="nc">MyString</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">string_content</span><span class="p">;</span>  <span class="c1">// 문자열 데이터를 가리키는 포인터
</span><span class="c1"></span>  <span class="kt">int</span> <span class="n">string_length</span><span class="p">;</span>     <span class="c1">// 문자열 길이
</span><span class="c1"></span>
  <span class="kt">int</span> <span class="n">memory_capacity</span><span class="p">;</span>  <span class="c1">// 현재 할당된 용량
</span><span class="c1"></span>
 <span class="k">public</span><span class="o">:</span>
  <span class="n">MyString</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 문자열로 부터 생성
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 복사 생성자
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="c1">// 이동 생성자
</span><span class="c1"></span>  <span class="n">MyString</span><span class="p">(</span><span class="n">MyString</span> <span class="o">&amp;</span><span class="o">&amp;</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">reserve</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="o">&amp;</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span><span class="p">;</span>
  <span class="o">~</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="kt">int</span> <span class="nf">length</span><span class="p">(</span><span class="p">)</span> <span class="k">const</span><span class="p">;</span>

  <span class="kt">void</span> <span class="nf">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span><span class="p">;</span>

<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">)</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">복사 생성자 호출 ! </span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">MyString</span><span class="p">(</span><span class="n">MyString</span> <span class="o">&amp;</span><span class="o">&amp;</span><span class="n">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">이동 생성자 호출 !</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">str</span><span class="p">.</span><span class="n">memory_capacity</span><span class="p">;</span>

  <span class="c1">// 임시 객체 소멸 시에 메모리를 해제하지
</span><span class="c1"></span>  <span class="c1">// 못하게 한다.
</span><span class="c1"></span>  <span class="n">str</span><span class="p">.</span><span class="n">string_content</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">string_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">memory_capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="o">~</span><span class="n">MyString</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">string_content</span><span class="p">)</span> <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">string_content</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">reserve</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">memory_capacity</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">prev_string_content</span> <span class="o">=</span> <span class="n">string_content</span><span class="p">;</span>

    <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">size</span><span class="p">]</span><span class="p">;</span>
    <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
      <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prev_string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">prev_string_content</span> <span class="o">!</span><span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">prev_string_content</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="n">MyString</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="k">operator</span><span class="o">+</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MyString</span> <span class="n">str</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">string_length</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">)</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span>
    <span class="n">str</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">string_length</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="n">str</span><span class="p">.</span><span class="n">string_length</span> <span class="o">=</span> <span class="n">string_length</span> <span class="o">+</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">str</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">MyString</span> <span class="o">&amp;</span><span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">복사!</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">string_length</span> <span class="o">&gt;</span> <span class="n">memory_capacity</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">delete</span><span class="p">[</span><span class="p">]</span> <span class="n">string_content</span><span class="p">;</span>
    <span class="n">string_content</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">char</span><span class="p">[</span><span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">]</span><span class="p">;</span>
    <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">length</span><span class="p">(</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">string_length</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="n">println</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">!</span><span class="o">=</span> <span class="n">string_length</span><span class="p">;</span> <span class="n">i</span><span class="o">+</span><span class="o">+</span><span class="p">)</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">string_content</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">my_swap</span><span class="p">(</span><span class="n">T</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">,</span> <span class="n">T</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">T</span> <span class="n">tmp</span><span class="p">(</span><span class="n">move</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
  <span class="n">a</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="p">;</span>
  <span class="n">b</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">MyString</span> <span class="n">str1</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">abc</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">MyString</span> <span class="nf">str2</span><span class="p">(</span><span class="sa"></span><span class="s">&#34;</span><span class="s">def</span><span class="s">&#34;</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Swap 전 -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str1 : </span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">str1</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str2 : </span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">str2</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Swap 후 -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">my_swap</span><span class="p">(</span><span class="n">str1</span><span class="p">,</span> <span class="n">str2</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str1 : </span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">str1</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">str2 : </span><span class="s">&#34;</span><span class="p">;</span>
  <span class="n">str2</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>성공적으로 컴파일 하였다면</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile4.uf.tistory.com%2Fimage%2F99BA0F435AB9A114146E55' alt=''><p>와 같이 나옵니다.</p><p>위에서 보시다싶이 <code class='inline-code'>swap</code> 은 잘 되었지만, 공교롭게도 두 번의 복사를 수행하였습니다.</p><pre class="chroma">
<span class="n">a</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="p">;</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">move</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="p">;</span>
</pre><p>왜냐하면 바로 위 두 줄 때문이지요. 비록 <code class='inline-code'>move</code> 를 시키고자 하였지만, 오버로딩 된 <code class='inline-code'>operator=</code> 가 복사를 수행하였습니다. 그 이유는 현재 정의된 <code class='inline-code'>operator=</code> 가</p><pre class="chroma">
<span class="n">MyString</span><span class="o">&amp;</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="k">const</span> <span class="n">MyString</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
</pre><p>꼴 이므로, <code class='inline-code'>s</code> 를 그대로 복사하기 때문이지요. 따라서 우리는 우측값에만 특이적으로 오버로딩 되는 <code class='inline-code'>operator=</code> 를 정의해줘야만 합니다. 아래와 같이 말이지요.</p><pre class="chroma">
<span class="n">MyString</span><span class="o">&amp;</span> <span class="n">MyString</span><span class="o">:</span><span class="o">:</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">MyString</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">이동!</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">string_content</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_content</span><span class="p">;</span>
  <span class="n">memory_capacity</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">memory_capacity</span><span class="p">;</span>
  <span class="n">string_length</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">string_length</span><span class="p">;</span>

  <span class="n">s</span><span class="p">.</span><span class="n">string_content</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="n">s</span><span class="p">.</span><span class="n">memory_capacity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">s</span><span class="p">.</span><span class="n">string_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>그리고 성공적으로 컴파일 하였다면</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile1.uf.tistory.com%2Fimage%2F99ABCE4F5AB9A225263122' alt=''><p>와 같이 제대로 이동을 시키고 있음을 알 수 있습니다.</p><p>새롭게 정의한 <code class='inline-code'>operator=</code> 를 살펴보면 매우 간단합니다. 굳이 문자열 전체를 복사할 필요가 없이, 단순히 <code class='inline-code'>string_content</code> 값만 복사해주면 되기 때문이지요. 물론 s 에 있던 문자열은 사라지게 됩니다. 하지만 상관 없습니다. 어차피 우측값 이니까요!</p><h3><p>  완벽한 전달 (perfect forwarding)</p></h3><p><code class='inline-code'>C++ 11</code> 에 우측값 레퍼런스가 도입되기 전 까지 해결할 수 없었던 문제가 있었습니다. 예를 들어서 아래와 같은 <code class='inline-code'>wrapper</code> 함수를 생각해봅시다 C++ 11 에 우측값 레퍼런스가 도입되기 전 까지 해결할 수 없었던 문제가 있었습니다. 예를 들어서 아래와 같은 <code class='inline-code'>wrapper</code> 함수를 생각해봅시다.</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>이 함수는 인자로 받은 <code class='inline-code'>u</code> 를 그대로 <code class='inline-code'>g</code> 라는 함수에 인자로 '전달' 해줍니다. 물론 왜 저런 함수가 필요하나고 생각할 수 있습니다. 그냥 저런 <code class='inline-code'>wrapper</code> 함수를 만들지 말고 그냥 <code class='inline-code'>g(u)</code> 를 호출하면 되잖아요?</p><p>하지만 실제로 저러한 형태의 전달 방식이 사용되는 경우가 종종 있습니다. 예를 들어 <code class='inline-code'>STL</code> 의 <code class='inline-code'>vector</code> 에는 <code class='inline-code'>emplace_back</code> 이라는 함수가 있습니다. 예를 들어서 클래스 <code class='inline-code'>A</code> 를 원소로 가지는 벡터의 뒤에 원소를 추가하기 위해서는</p><pre class="chroma">
<span class="n">vec</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</pre><p>과 같이 객체를 생성한 뒤에 인자로 전달해줘야만 합니다. 하지만 이 과정에서 불필요한 이동 혹은 복사가 발생하게 됩니다. 그렇다면, 아예 벡터에 인자를 전달해준 다음, 벡터 내부에서 자체적으로 객체를 생성한 뒤에 벡터 뒤에 추가하면 어떨까요? 이를 가능하게 하는게 <code class='inline-code'>emplace_back</code> 함수 입니다.</p><pre class="chroma">
<span class="n">vec</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="p">;</span>  <span class="c1">// 위와 동일한 작업을 수행한다.
</span><span class="c1"></span></pre><p><code class='inline-code'>emplace_back</code> 함수는 인자를 직접 전달받아서, 내부에서 <code class='inline-code'>A</code> 의 생성자를 호출한 뒤에 이를 벡터 원소 뒤에 추가하게 되지요. 이 과정에서 불필요한 이동/복사 모두 발생하지 않습니다. 참고로 새로 생성한 객체를 벡터 뒤에 추가할 경우 위와 같이 <code class='inline-code'>push_back</code> 을 이용하는 것 보다 <code class='inline-code'>emplace_back</code> 을 이용하는 것이 권장되는 방식입니다.</p><p>그렇다면 문제는 <code class='inline-code'>emplace_back</code> 함수가 받은 인자들을 <code class='inline-code'>A</code> 의 생성자에 제대로 전달해야 합니다. 그렇지 않을 경우 사용자가 의도하지 않은 생성자가 호출될 수 있기 때문입니다. 그렇다면 위와 같은 <code class='inline-code'>wrapper</code> 함수를 어떻게 하면 잘 정의할 수 있을까요?</p><pre class="chroma">
<span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span><span class="err"> </span><span class="nc">A</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">좌측값 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">좌측값 상수 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">우측값 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">A</span> <span class="n">a</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">A</span> <span class="n">ca</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">원본 --------</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Wrapper -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>성공적으로 컴파일 하였다면!</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile2.uf.tistory.com%2Fimage%2F99ADBC435AB9C1621B4011' alt=''><p>와 같이 나옵니다.</p><pre class="chroma">
<span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">원본 --------</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
<span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
<span class="n">g</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
<span class="n">g</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</pre><p>먼저 위 경우 우리의 예상대로 좌측값 레퍼런스, 좌측값 상수 레퍼런스, 우측값 레퍼런스가 각각 호출되었습니다. 반면에 <code class='inline-code'>wrapper</code> 함수를 거쳐갔을 경우, 공교롭게도 위 세 경우 모두 좌측값 레퍼런스를 받는 <code class='inline-code'>g</code> 함수가 호출되었습니다.</p><p>이러한 일이 발생한 이유는 C++ 컴파일러가 템플릿 타입을 추론할 때,템플릿 인자 <code class='inline-code'>T</code> 가 레퍼런스가 아닌 일반적인 타입이라면 <code class='inline-code'>const</code> 를 무시하기 때문 <a href='#footnote_228_1'>[각주:</a><code class='inline-code'>1 1</code>]</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>에서 <code class='inline-code'>T</code> 가 전부 다 <code class='inline-code'>class A</code> 로 추론됩니다. 따라서 위 세 경우 전부 다 좌측값 레퍼런스를 호출하는 <code class='inline-code'>g</code> 를 호출하였습니다.</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>그렇다면 위 경우는 어떨까요?</p><pre class='warning'>
error
    : cannot bind non -
      const lvalue reference of type 'A&' to an rvalue of type 'A' wrapper(A());
^~~
</pre><p>위와 같은 컴파일 오류가</p><p>g(A());</p><p>에서 발생합니다. (참고로 이 오류는 <code class='inline-code'>gcc</code> 와 <code class='inline-code'>clang</code> 컴파일러에서 모두 발생하는데, 비주얼 스튜디오에서는 발생하지 않습니다. 하지만 원칙적으로 위와 같은 오류를 발생시켜야 하는 것이 맞습니다<code class='inline-code'>).</code></p><p>왜 위와 같은 오류가 발생하는지 생각해보자면 다음과 같습니다. 일단, <code class='inline-code'>A()</code> 자체는 <code class='inline-code'>const</code> 속성이 없으므로 템플릿 인자 추론에서 <code class='inline-code'>T</code> 가 <code class='inline-code'>class A</code> 로 추론됩니다. 하지만 <code class='inline-code'>A&</code> 는 우측값의 레퍼런스가 될 수 없기 때문에 컴파일 오류가 발생하는 것입니다.</p><p>그렇다면 아예 우측값을 레퍼런스로 받을 수 있도록 <code class='inline-code'>const A&</code> 와 <code class='inline-code'>A&</code> 따로 만들어주는 방법이 있습니다. 아래와 같이 말이지요.</p><pre class="chroma">
<span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;vector&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">T&amp; 로 추론됨</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">const T&amp; 로 추론됨</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span><span class="err"> </span><span class="nc">A</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">좌측값 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">좌측값 상수 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">우측값 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">A</span> <span class="n">a</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">A</span> <span class="n">ca</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">원본 --------</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Wrapper -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>성공적으로 컴파일 하였다면</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile7.uf.tistory.com%2Fimage%2F99DB5A3A5ABA0364292293' alt=''><p>와 같이 나옵니다.</p><p>일단 <code class='inline-code'>a</code> 와 <code class='inline-code'>ca</code> 의 경우 각각 <code class='inline-code'>T&</code> 와 <code class='inline-code'>const T&</code> 로 잘 추론되서 올바른 함수를 호출하고 있음을 알 수 있습니다. 반면에 <code class='inline-code'>A()</code> 의 경우 <code class='inline-code'>const T&</code> 로 추론되면서 <code class='inline-code'>g(const T&)</code> 함수를 호출하게 됩니다. 물론 이는 예상했던 일입니다. 우리가 무엇을 해도 <code class='inline-code'>wrapper</code> 안에 <code class='inline-code'>u</code> 가 좌측값이라는 사실은 변하지 않고 이에 언제나 좌측값 레퍼런스를 받는 함수들이 오버로딩 되겠지요.</p><p>뿐만이 아니라 다음과 같은 문제가 있습니다. 예를 들어서 함수 <code class='inline-code'>g</code> 가 인자를 한 개가 아니라 2 개를 받는다고 가정합니다. 그렇다면 우리는 다음과 같은 모든 조합의 템플릿 함수들을 정의해야합니다.</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">,</span> <span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>매우 귀찮은 일입니다. 위와 같이 짜야하는 이유는 단순히 일반적인 레퍼런스가 우측값을 받을 수 없기 때문입니다. 그렇다고 해서 디폴트로 상수 레퍼런스만 받게 된다면, 상수가 아닌 레퍼런스도 상수 레퍼런스로 캐스팅되서 들어간다는 점이지요.</p><p>하지만 놀랍게도 C++ 11 에서는 이를 간단하게 해결할 수 있습니다.</p><pre class="chroma">
<span class="cp">#</span><span class="cp">include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="cp"></span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span><span class="err"> </span><span class="nc">A</span> <span class="p">{</span><span class="p">}</span><span class="p">;</span>

<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">좌측값 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="k">const</span> <span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">좌측값 상수 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>
<span class="kt">void</span> <span class="nf">g</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="p">{</span> <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">우측값 레퍼런스 호출</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span> <span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">A</span> <span class="n">a</span><span class="p">;</span>
  <span class="k">const</span> <span class="n">A</span> <span class="n">ca</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">원본 --------</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
  <span class="n">g</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>

  <span class="n">cout</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="sa"></span><span class="s">&#34;</span><span class="s">Wrapper -----</span><span class="s">&#34;</span> <span class="o">&lt;</span><span class="o">&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
  <span class="n">wrapper</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>성공적으로 컴파일 하였다면</p><img class='content-img' src='http://img1.daumcdn.net/thumb/R1920x0/?fname=http%3A%2F%2Fcfile5.uf.tistory.com%2Fimage%2F99772B4C5ABA05F832FD06' alt=''><p>와 같이 잘 작동함을 알 수 있습니다.</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
<span class="kt">void</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">T</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">u</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">g</span><span class="p">(</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>일단 우리의 <code class='inline-code'>wrapper</code> 함수는 인자로 아예 <code class='inline-code'>T&&</code> 를 받아버리고 있습니다. 아니 이렇게 된다면 도대체 좌측값은 어떻게 받겠다는 것일까요? 사실 C++ 11 에서 템플릿 인자들 간에 다음과 같은 레퍼런스 겹침 규칙 (reference collapsing rule) 을 정하였습니다.</p><pre class='info'>
typedef int& T;
T& r1;   // int& &; r1 은 int&
T&& r2;  // int & &&; r2 는 int&

typedef int&& U U& r3;  // int && &; r3 는 int&
U&& r4;                 // int && &&; r4 는 int&&
</pre><p>즉 쉽게 생각하면 <code class='inline-code'>&</code> 는 1 이고 <code class='inline-code'>&&</code> 은 0 이라 둔 뒤에, <code class='inline-code'>OR</code> 연산을 한다고 보면 됩니다. 그렇다면,</p><pre class="chroma">
<span class="n">wrapper</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
<span class="n">wrapper</span><span class="p">(</span><span class="n">ca</span><span class="p">)</span><span class="p">;</span>
</pre><p>위 두 개의 호출의 경우 <code class='inline-code'>T</code> 가 각각 <code class='inline-code'>A&</code> 와 <code class='inline-code'>const A&</code> 로 추론될 것이고,</p><pre class="chroma">
<span class="n">wrapper</span><span class="p">(</span><span class="n">A</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</pre><p>의 경우에는 <code class='inline-code'>T</code> 가 단순히 <code class='inline-code'>A&&</code> 로 추론되겠지요.</p><p>그런데 문제는 이제 직접 <code class='inline-code'>g</code> 에 이 인자를 전달하는 방법입니다. 왜 그냥</p><pre class="chroma">
<span class="n">g</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
</pre><p>로 하지 않았는지 생각해봅시다. 앞서도 말했듯이 여기서 <code class='inline-code'>u</code> 는 좌측값 입니다. <code class='inline-code'>u</code> 가 우측값 레퍼런스임에도 불구하고, const <code class='inline-code'>int&</code> 를 오버로딩하는 <code class='inline-code'>g</code> 가 호출되게 됩니다. 물론 우리는 좌측값을 어떻게 하면 우측값으로 캐스팅 시킬지 알고 있습니다. 바로 <code class='inline-code'>move</code> 를 이용하는 것입니다.</p><p>하지만 위 경우 아무때나 <code class='inline-code'>move</code> 를 하면 안됩니다. 인자로 받은 <code class='inline-code'>u</code> 가 우측값 레퍼런스 일 때 에만 <code class='inline-code'>move</code> 를 해줘야만 하는 것입니다. 만일 좌측값 레퍼런스일 때 <code class='inline-code'>move</code> 를 해버린다면 좌측값에 오버로딩 되는 <code class='inline-code'>g</code> 가 아닌 우측값에 오버로딩 되는 <code class='inline-code'>g</code> 가 호출되겠지요.</p><pre class="chroma">
<span class="n">g</span><span class="p">(</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">(</span><span class="n">u</span><span class="p">)</span><span class="p">)</span><span class="p">;</span>
</pre><p>이 문제를 해결해주는 것이 <code class='inline-code'>forward</code> 함수 입니다. 이 함수는 <code class='inline-code'>u</code> 가 우측값 레퍼런스 일 때 에만 마치 <code class='inline-code'>move</code> 를 적용한 것 처럼 작동합니다. 실제로 <code class='inline-code'>forward</code> 가 어떻게 생겼나면,</p><pre class="chroma">
<span class="k">template</span> <span class="o">&lt;</span><span class="k">class</span><span class="err"> </span><span class="nc">S</span><span class="o">&gt;</span>
<span class="n">S</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">forward</span><span class="p">(</span><span class="k">typename</span> <span class="n">remove_reference</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;</span><span class="o">:</span><span class="o">:</span><span class="n">type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&amp;</span><span class="o">&amp;</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>와 같이 생겼는데, <code class='inline-code'>S</code> 가 <code class='inline-code'>A&</code> 라면 (참고로 <code class='inline-code'>remove_reference</code> 는 타입의 레퍼런스를 지워주는 템플릿 메타 함수 입니다)</p><pre class="chroma">
<span class="n">A</span><span class="o">&amp;</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">forward</span><span class="p">(</span><span class="k">typename</span> <span class="n">remove_reference</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&amp;</span><span class="o">&gt;</span><span class="o">:</span><span class="o">:</span><span class="n">type</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span>
  <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&amp;</span><span class="o">&amp;</span><span class="o">&amp;</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span>
<span class="p">}</span>
</pre><p>가 되어 레퍼런스 겹침 규칙에 따라</p><pre class="chroma">
<span class="n">A</span><span class="o">&amp;</span> <span class="n">forward</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&amp;</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span> <span class="p">}</span>
</pre><p>가 되버리고, <code class='inline-code'>S</code> 가 그냥 <code class='inline-code'>A</code> 라면, (퀴즈! 여기서 왜 <code class='inline-code'>forward</code> 의 인자가 <code class='inline-code'>A&&</code> 가 아니라 A& 일까요?)</p><pre class="chroma">
<span class="n">A</span><span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">forward</span><span class="p">(</span><span class="n">A</span><span class="o">&amp;</span> <span class="n">a</span><span class="p">)</span> <span class="k">noexcept</span> <span class="p">{</span> <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&amp;</span><span class="o">&amp;</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="p">;</span> <span class="p">}</span>
</pre><p>가 되어 성공적으로 우측값으로 캐스팅해줍니다. 따라서 결과적으로 위 그림 처럼 원본과 <code class='inline-code'>Wrapper</code> 을 사용했을 때 모두 호출되는 함수가 동일함을 알 수 있습니다. 성공적으로 인자를 전달한 것이지요!</p><p>자 그럼 이것으로 이번 강좌를 마치도록 하겠습니다. 다음 강좌에서는 여태까지 배운 내용을 바탕으로 스마트 포인터를 사용하는 방법에 대해서 다루어보도록 하겠습니다.</p><h3><p>  생각 해보기</p></h3><p><code class='inline-code'>1.</code> 실제로 <code class='inline-code'>move</code> 와 <code class='inline-code'>forward</code> 가 어떠한 방식으로 구현되어 있는지 궁금하신 분들은 <a href='https://gcc.gnu.org/onlinedocs/libstdc++/libstdc++-api-4.5/a00936_source.html'>여기를 참고하시면 됩니다</a><code class='inline-code'>.</code> 한 번 코드를 보시고 왜 이런 방식으로 구현되어 있는지 생각해보세요. (난이도 : 중 . 한 번 코드를 보시고 왜 이런 방식으로 구현되어 있는지 생각해보세요. (난이도 : 중)</p><pre class='warning'>강좌를 보다가 조금이라도 궁금한 것이나 이상한 점이 있다면꼭 댓글을 남겨주시기 바랍니다. 그 외에도 강좌에 관련된 것이라면 어떠한 것도 질문해 주셔도 상관 없습니다. 생각해 볼 문제도 정 모르겠다면 댓글을 달아주세요.

현재 여러분이 보신 강좌는<<씹어먹는 C++ - <11 - 2. Move 문법 (move semantics) 과 완벽한 전달 (perfect forwarding)>>> 입니다. 이번 강좌의모든 예제들의 코드를 보지 않고 짤 수준까지 강좌를 읽어 보시기 전까지 다음 강좌로 넘어가지 말아주세요


[다음 강좌 보러가기](http://itguru.tistory.com/135)
</pre><ol><li><p> http://en.cppreference.com/w/cpp/language/template<span class='font-italic'>argument</span>deduction <code class='inline-code'>              </code> 에서 <code class='inline-code'>Deduction from a function call</code> 의 첫번째 항목을 읽어보세요.[[본문으로]](#footnote<span class='font-italic'>link</span>228<span class='font-italic'>1)</p></li></ol>